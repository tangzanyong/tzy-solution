# 重复提交解决方案
示例参考：tzy-solution-resubmit
## 1.重复提交产生原因  
> 由于重复点击或者网络重发 eg:  
> 1)、点击提交按钮两次;  
> 2)、点击刷新按钮;  
> 3)、使用浏览器后退按钮重复之前的操作，导致重复提交表单;  
> 4)、使用浏览器历史记录重复提交表单;  
> 5)、浏览器重复的HTTP请;  
> 6)、nginx重发等情况;  
> 7)、分布式RPC的try重发等; 
  
## 2.重复提交导致数据不幂等
> 什么是幂等?  
> ![](./imgs/20200525151138.jpg)   
> 在编程中常见幂等  
> 1)、select查询天然幂等    
> 2)、delete删除也是幂等,删除同一个多次效果一样   
> 3)、update直接更新某个值的,幂等   
> 4)、update更新累加操作的,非幂等   
> 5)、insert非幂等操作,每次新增一条  

## 3.解决重复提交的几种解决方案
### 3.1) 前端js提交禁止按钮(可以用一些js组件)  
### 3.2) 使用Post/Redirect/Get模式
```
在提交后执行页面重定向，这就是所谓的Post-Redirect-Get (PRG)模式。
简言之，当用户提交了表单后，你去执行一个客户端的重定向，转到提交成功信息页面。
这能避免用户按F5导致的重复提交，而其也不会出现浏览器表单重复提交的警告，
也能消除按浏览器前进和后退按导致的同样问题。
```
### 3.3)在session中存放一个特殊标志
```
在服务器端，生成一个唯一的标识符，将它存入session，同时将它返回前端并写入页面表单的隐藏字段中，
然后用户录入表信息后点击提交，在服务器端，获取表单中隐藏字段的值，
与session中的唯一标识符比较，相等说明是首次提交，就处理本次请求，然后将session中的唯一标识符移除；
不相等说明是重复提交，就不再处理。
注意：服务器存储session的名称要避免重复，否则后面的会充掉前面的。
```
### 3.4)其他借助使用header头设置缓存控制头Cache-control等方式
```
比较复杂 不适合移动端APP的应用 这里不详解
```
### 3.5)借助数据库
```
insert使用唯一索引 update使用 乐观锁 version版本法
这种在大数据量和高并发下效率依赖数据库硬件能力,可针对非核心业务
```
### 3.6)借助悲观锁
```
使用select … for update ,这种和 synchronized 锁住先查再insert or update一样,但要避免死锁,效率也较差
针对单体 请求并发不大 可以推荐使用
```
### 3.7)借助本地锁(重点)

### 3.8)借助分布式redis锁(重点)
1.拦截请求  
2.生成业务key  
3.给key加锁，加锁不成功 提示重复提交 终止请求，否则就正常执行...  
4.给key加锁  

参考资料  
* [Spring注解方式防止重复提交原理详解](https://www.jb51.net/article/151467.htm)
* [8种方案解决重复提交问题](https://www.cnblogs.com/javazhiyin/p/11407140.html)
* [搞定重复提交（分布式锁）](https://blog.battcn.com/2018/06/13/springboot/v2-cache-redislock/)


